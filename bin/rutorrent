#!/usr/bin/env bash
set -Eeuo pipefail

root=$(dirname "$(dirname "$(realpath "${BASH_SOURCE[0]}")")")

PATH="$root/bin:$PATH"
uid=${RUTORRENT_UID:-$(user-uid)}
gid=${RUTORRENT_GID:-$(user-gid)}

declare -a args=()
args=(--interactive --tty)
for arg in "$@"; do
    if [[ "$arg" == -d || "$arg" == --daemon ]]; then
        args=(--detach)
    fi
done

shopt -s nullglob
for dir in "${RUTORRENT_PLUGIN_ROOT:-$root/..}"/rutorrent-*; do
    dir=$(realpath "$dir")
    name=$(basename "$dir")
    name=${name#rutorrent-}
    if [[ -f "$dir/$name/plugin.info" ]]; then
        args+=(--volume "$dir/$name:/app/rutorrent/plugins/$name")
    fi
done

declare -A volumes=()
volumes['music/.unsorted']='/music/.unsorted'
volumes['torrents/config']='/config'
volumes['torrents/data']='/downloads'
volumes['video/movies']='/downloads/completed/movies'
volumes['video/series']='/downloads/completed/series'
for k in "${!volumes[@]}"; do
    host_path="$root/$k"
    mkdir -pv "$host_path"
    chown -v "$uid:$gid" "$host_path"
    args+=(--volume "$host_path:${volumes[$k]}")
done

exec docker run \
    "${args[@]}" \
    --entrypoint /config/entrypoint.sh \
    --env PUID="$uid" \
    --env PGID="$gid" \
    --env PHP_OPCACHE="${PHP_OPCACHE:-true}" \
    --name=rutorrent \
    --publish "${RUTORRENT_PORT:-8000}:80" \
    --rm \
    linuxserver/rutorrent
