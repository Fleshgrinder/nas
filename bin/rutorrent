#!/usr/bin/env bash
set -Eeuo pipefail

plugins=()
for dir in ../rutorrent-*; do
    dir=$(realpath "$dir")
    name=$(basename "$dir")
    name=${name#rutorrent-}
    if [[ -f "$dir/$name/plugin.info" ]]; then
        plugins+=(--volume "$dir/$name:/app/rutorrent/plugins/$name")
    fi
done

exec docker run \
    --entrypoint /config/entrypoint.sh \
    --env PGID="$(id -g)" \
    --env PUID="$(id -u)" \
    --env PHP_OPCACHE="${PHP_OPCACHE:-true}" \
    --interactive \
    --name=rutorrent \
    --publish "${RTORRENT_PORT:-51413}:51413" \
    --publish "${RUTORRENT_PORT:-80}:80" \
    --rm \
    --tty \
    --volume "${CURDIR}/src/music/.unsorted:/music/.unsorted" \
    --volume "${CURDIR}/src/torrent/config:/config" \
    --volume "${CURDIR}/src/torrent/data:/downloads" \
    --volume "${CURDIR}/src/video/movie:/downloads/completed/movie" \
    --volume "${CURDIR}/src/video/series:/downloads/completed/series" \
    "${plugins[@]}" \
    linuxserver/rutorrent
