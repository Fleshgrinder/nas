#!/usr/bin/env bash
set -Eeuo pipefail

plugins=()
for dir in ../rutorrent-*; do
    dir=$(realpath "$dir")
    name=$(basename "$dir")
    name=${name#rutorrent-}
    if [[ -f "$dir/$name/plugin.info" ]]; then
        plugins+=(--volume "$dir/$name:/app/rutorrent/plugins/$name")
    fi
done

mkdir -p music/.unsorted torrents/data video/movies video/series

exec docker run \
    --entrypoint /config/entrypoint.sh \
    --env PGID="$(id -g)" \
    --env PUID="$(id -u)" \
    --env PHP_OPCACHE="${PHP_OPCACHE:-true}" \
    --interactive \
    --name=rutorrent \
    --publish "${RUTORRENT_PORT:-80}:80" \
    --rm \
    --tty \
    --volume "${CURDIR}/music/.unsorted:/music/.unsorted" \
    --volume "${CURDIR}/torrents/config:/config" \
    --volume "${CURDIR}/torrents/data:/downloads" \
    --volume "${CURDIR}/video/movies:/downloads/completed/movies" \
    --volume "${CURDIR}/video/series:/downloads/completed/series" \
    "${plugins[@]}" \
    linuxserver/rutorrent
