#!/usr/bin/env bash
set -Eeuo pipefail
shopt -s nullglob

root=$(dirname "$(dirname "${BASH_SOURCE[0]}")")
PATH="$root/bin:$PATH"

plugins=()
for dir in "${RUTORRENT_PLUGIN_ROOT:-$root/..}"/rutorrent-*; do
    dir=$(realpath "$dir")
    name=$(basename "$dir")
    name=${name#rutorrent-}
    if [[ -f "$dir/$name/plugin.info" ]]; then
        plugins+=(--volume "$dir/$name:/app/rutorrent/plugins/$name")
    fi
done

uid=${RUTORRENT_UID:-$(user-uid)}
gid=${RUTORRENT_GID:-$(user-gid)}

for dir in music/.unsorted torrents/data video/movies video/series; do
    dir=$root/$dir
    if [[ ! -d "$dir" ]]; then
        mkdir -p "$dir"
        chown "$uid:$gid" "$dir"
    fi
done

exec docker run \
    --entrypoint /config/entrypoint.sh \
    --env PGID="$gid" \
    --env PUID="$uid" \
    --env PHP_OPCACHE="${PHP_OPCACHE:-true}" \
    --interactive \
    --name=rutorrent \
    --publish "${RUTORRENT_PORT:-8000}:80" \
    --rm \
    --tty \
    --volume "$root/music/.unsorted:/music/.unsorted" \
    --volume "$root/torrents/config:/config" \
    --volume "$root/torrents/data:/downloads" \
    --volume "$root/video/movies:/downloads/completed/movies" \
    --volume "$root/video/series:/downloads/completed/series" \
    "${plugins[@]}" \
    linuxserver/rutorrent
